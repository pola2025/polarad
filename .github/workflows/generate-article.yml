name: Auto Generate Article

on:
  schedule:
    # ì›”/ìˆ˜/ê¸ˆ/ì¼ ì˜¤ì „ 9ì‹œ (KST) = UTC 00:00
    - cron: '0 0 * * 0,1,3,5'
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Call Generate Article API
        id: generate
        run: |
          echo "ğŸš€ ê¸€ ìƒì„± API í˜¸ì¶œ ì‹œì‘..."
          echo "ì‹œê°„: $(TZ='Asia/Seoul' date '+%Y-%m-%d %H:%M:%S KST')"

          response=$(curl -s -w "\n%{http_code}" \
            --max-time 300 \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "https://www.polarad.co.kr/api/cron/generate-article")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "ğŸ“„ Response: $body"
          echo "ğŸ“Š HTTP Code: $http_code"

          if [ "$http_code" -ne 200 ]; then
            echo "âŒ API í˜¸ì¶œ ì‹¤íŒ¨: $http_code"
            exit 1
          fi

          # ê²°ê³¼ íŒŒì‹±
          if echo "$body" | grep -q '"skipped":true'; then
            echo "â­ï¸ ì˜¤ëŠ˜ì€ ì‹¤í–‰ ìš”ì¼ì´ ì•„ë‹™ë‹ˆë‹¤."
          elif echo "$body" | grep -q '"success":true'; then
            title=$(echo "$body" | grep -o '"title":"[^"]*"' | cut -d'"' -f4)
            echo "âœ… ê¸€ ìƒì„± ì„±ê³µ!"
            echo "ğŸ“ ì œëª©: $title"
          else
            echo "âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” ì‘ë‹µ"
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "âŒ ê¸€ ìƒì„± ì‹¤íŒ¨ - ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”"
          echo "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
