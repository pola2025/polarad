/**
 * Instagram ì»¨í…ì¸  ìƒì„±ê¸°
 * polarad.co.kr ê¸°ë°˜ ì»¨í…ì¸  ìƒì„±
 *
 * âš ï¸ GEMINI ëª¨ë¸ ì ˆëŒ€ê·œì¹™ (ë³€ê²½ ê¸ˆì§€) âš ï¸
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * | ìš©ë„           | ëª¨ë¸                          |
 * |----------------|-------------------------------|
 * | í…œí”Œë¦¿ ë°ì´í„°  | gemini-3-flash-preview        |
 * | ìº¡ì…˜ ìƒì„±      | gemini-3-pro-preview          |
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 * âŒ Gemini 2.x ë²„ì „ ì‚¬ìš© ì ˆëŒ€ ê¸ˆì§€
 * âŒ ëª¨ë¸ëª… ì„ì˜ ë³€ê²½ ê¸ˆì§€
 */

import { TemplateData, TemplateType, TEMPLATE_TYPES } from './instagram-templates';

const GEMINI_API_KEY = process.env.GEMINI_API_KEY;

// polarad.co.kr ì„œë¹„ìŠ¤ ë‚´ìš© ê¸°ë°˜ ì»¨í…ì¸  í’€
const CONTENT_TOPICS = {
  intro: {
    themes: [
      '30ë§Œì›ë¶€í„° ì‹œì‘í•˜ëŠ” ì˜¨ë¼ì¸ ì˜ì—… ì‹œìŠ¤í…œ',
      '4í‹°ì–´ ë§ì¶¤í˜• ì˜¨ë¼ì¸ ì˜ì—… ì†”ë£¨ì…˜',
      'DB ìˆ˜ì§‘ë¶€í„° ê³„ì•½ê¹Œì§€ ì›ìŠ¤í†± ì†”ë£¨ì…˜',
      'í•„ìš”í•œ ë§Œí¼ë§Œ ì„ íƒí•˜ëŠ” ìŠ¤ë§ˆíŠ¸í•œ ë§ˆì¼€íŒ…',
    ],
    services: ['í™ˆí˜ì´ì§€', 'Meta ê´‘ê³ ', 'ë§ˆì¼€íŒ… ìë™í™”', 'DB ìˆ˜ì§‘'],
  },
  problem: {
    painPoints: [
      'ê³µìœ  DBë¡œ ê²½ìŸë§Œ ì¹˜ì—´',
      'ë¯¸íŒ… ì„±ì‚¬ìœ¨ 5% ë¯¸ë§Œ',
      'ë§¤ì›” ìˆ˜ë°±ë§Œ ì› DB ë¹„ìš©',
      'ì½œë“œì½œë¡œ ì‹œê°„ë§Œ ë‚­ë¹„',
      'ê´‘ê³ ë¹„ëŠ” ì“°ëŠ”ë° ì„±ê³¼ëŠ” ì—†ê³ ',
      'DB í’ˆì§ˆì´ ë„ˆë¬´ ë‚®ì•„ì„œ',
    ],
    questions: [
      'ì•„ì§ë„ ë‚¨ë“¤ì´ ë²„ë¦° DBì— ì „í™”ë¥¼ ëŒë¦¬ê³  ê³„ì‹­ë‹ˆê¹Œ?',
      'ê´‘ê³ ë¹„ë§Œ ì“°ê³  ì„±ê³¼ëŠ” ì—†ìœ¼ì‹ ê°€ìš”?',
      'ë§¤ì¼ ì½œë“œì½œë§Œ í•˜ë‹¤ê°€ ì§€ì¹˜ì…¨ë‚˜ìš”?',
      'DB êµ¬ë§¤ ë¹„ìš©ì´ ë¶€ë‹´ë˜ì‹œë‚˜ìš”?',
    ],
  },
  solution: {
    packages: [
      { name: 'Basic 30ë§Œì›', desc: 'ëœë”©í˜ì´ì§€ 1P - ë¶€ë‹´ ì—†ì´ ì‹œì‘' },
      { name: 'Normal 60ë§Œì›', desc: 'ëœë”© 1P + Meta ì„¸íŒ… + ë„ë©”ì¸' },
      { name: 'Pro 110ë§Œì›', desc: 'í™ˆí˜ì´ì§€ 5P + Meta ì„¸íŒ… + ë„ë©”ì¸' },
      { name: 'Premium 165ë§Œì›', desc: 'í™ˆí˜ì´ì§€ 10P + 1ë…„ ìë™í™” (í”„ë¡œëª¨ì…˜)' },
    ],
    benefits: ['30ë§Œì›ë¶€í„° ë¶€ë‹´ ì—†ì´ ì‹œì‘', 'ì„±ê³¼ í™•ì¸ í›„ ì—…ê·¸ë ˆì´ë“œ ê°€ëŠ¥', '1ë…„ ìë™í™” ë¬´ë£Œ (Premium)'],
    lowBarrierMessages: [
      'ë¨¼ì € Basicìœ¼ë¡œ ì‹œì‘í•´ë³´ê³  ê²°ì •í•˜ì„¸ìš”',
      '30ë§Œì›ìœ¼ë¡œ íš¨ê³¼ë¥¼ ì§ì ‘ í™•ì¸í•´ë³´ì„¸ìš”',
      'ë¶€ë‹´ ì—†ì´ ì‹œì‘, ì„±ê³¼ ë³´ê³  ì—…ê·¸ë ˆì´ë“œ',
      'ì‘ê²Œ ì‹œì‘í•´ì„œ í¬ê²Œ ì„±ì¥í•˜ì„¸ìš”',
    ],
  },
  feature: {
    features: [
      { name: 'ì‹¤ì‹œê°„ ì•Œë¦¼', desc: 'ê³ ê° ë¬¸ì˜ ì¦‰ì‹œ ì•Œë¦¼' },
      { name: 'ìë™ ë¶„ë¥˜', desc: 'AI ê¸°ë°˜ ë¦¬ë“œ ìë™ ë¶„ë¥˜' },
      { name: 'DB ê´€ë¦¬', desc: 'ì²´ê³„ì ì¸ ê³ ê° ë°ì´í„° ê´€ë¦¬' },
      { name: 'ìë™ ë¦¬í¬íŠ¸', desc: 'ê´‘ê³  ì„±ê³¼ ìë™ ë¦¬í¬íŒ…' },
    ],
  },
  stats: {
    metrics: [
      { label: 'í‰ê·  DB ìˆ˜ì§‘', range: [80, 150], unit: 'ê±´' },
      { label: 'DBë‹¹ ë‹¨ê°€', range: [18000, 28000], unit: 'ì›' },
      { label: 'ë¯¸íŒ… ì „í™˜ìœ¨', range: [15, 35], unit: '%' },
      { label: 'ê´‘ê³  íš¨ìœ¨', range: [20, 40], unit: '% ê°œì„ ' },
    ],
  },
  promo: {
    offers: [
      'ì„ ì°©ìˆœ 10ê°œ ê¸°ì—… í•œì •!',
      '1ì›” 31ì¼ê¹Œì§€ í•œì • í”„ë¡œëª¨ì…˜!',
      'Premium í‹°ì–´ 55ë§Œì› í• ì¸!',
      '1ë…„ ìë™í™” ë¬´ë£Œ ì œê³µ!',
    ],
    benefits: [
      'Premium 165ë§Œì› (ì •ê°€ 220ë§Œì›)',
      '1ë…„ ìë™í™” ë¬´ë£Œ ì œê³µ',
      'í™ˆí˜ì´ì§€ 10P + Meta ì„¸íŒ…',
      'ë„ë©”ì¸ 1ë…„ ë¬´ë£Œ',
    ],
  },
  service: {
    services: [
      {
        name: 'í™ˆí˜ì´ì§€ ì œì‘',
        features: [
          { name: 'ë°˜ì‘í˜• ì›¹', desc: 'PC, ëª¨ë°”ì¼ ëª¨ë‘ ìµœì í™”' },
          { name: 'SEO ìµœì í™”', desc: 'ê²€ìƒ‰ì—”ì§„ ìƒìœ„ ë…¸ì¶œ' },
          { name: 'DB í¼ ì—°ë™', desc: 'ê³ ê° ë¬¸ì˜ ìë™ ìˆ˜ì§‘' },
        ],
      },
      {
        name: 'Meta ê´‘ê³ ',
        features: [
          { name: 'ì •ë°€ íƒ€ê²ŸíŒ…', desc: 'ì´ìƒì ì¸ ê³ ê°ì¸µ ê³µëµ' },
          { name: 'A/B í…ŒìŠ¤íŠ¸', desc: 'ìµœì ì˜ ê´‘ê³  ì†Œì¬ ë°œêµ´' },
          { name: 'ë¦¬íƒ€ê²ŸíŒ…', desc: 'ì´íƒˆ ê³ ê° ì¬ìœ ì…' },
        ],
      },
      {
        name: 'ë§ˆì¼€íŒ… ìë™í™”',
        features: [
          { name: 'í…”ë ˆê·¸ë¨ ì•Œë¦¼', desc: 'DB ì ‘ìˆ˜ ì¦‰ì‹œ ì•Œë¦¼' },
          { name: 'SMS ë°œì†¡', desc: 'ê³ ê° ë¬¸ì˜ ìë™ ì‘ë‹µ' },
          { name: 'ìë™ ë¦¬í¬íŠ¸', desc: 'ê´‘ê³  ì„±ê³¼ ì¼ì¼ ë³´ê³ ' },
        ],
      },
    ],
  },
  cta: {
    messages: [
      'ì˜ì—…ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”',
      'ë‚˜ë¨¸ì§€ëŠ” ì €í¬ê°€ ë‹¤ í•´ë“œë¦½ë‹ˆë‹¤',
      'ë³µì¡í•œ ë§ˆì¼€íŒ…ì€ ë§¡ê¸°ì„¸ìš”',
      'ëŒ€í‘œë‹˜ì€ ê³„ì•½ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”',
    ],
  },
  case: {
    cases: [
      {
        industry: 'ê²½ì˜ì»¨ì„¤íŒ…',
        period: '3ê°œì›”',
        stats: [
          { label: 'ê´‘ê³ ë¹„', value: 'â‚©320ë§Œ', change: 'ì›” ì˜ˆì‚°' },
          { label: 'DB ìˆ˜ì§‘', value: '150ê±´', change: 'ì›” í‰ê· ' },
          { label: 'ê³„ì•½ ì„±ì‚¬', value: '15ê±´', change: 'ì „í™˜ìœ¨ 10%' },
        ],
        quote: 'í´ë¼ì• ë“œ ë•ë¶„ì— ì˜ì—…ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆê²Œ ëìŠµë‹ˆë‹¤',
      },
      {
        industry: 'ì¸í…Œë¦¬ì–´',
        period: '3ê°œì›”',
        stats: [
          { label: 'ê´‘ê³ ë¹„', value: 'â‚©320ë§Œ', change: 'ì›” ì˜ˆì‚°' },
          { label: 'DB ìˆ˜ì§‘', value: '239ê±´', change: 'ì›” í‰ê· ' },
          { label: 'ê³„ì•½ ì„±ì‚¬', value: '10ê±´', change: 'ì „í™˜ìœ¨ 4.2%' },
        ],
        quote: 'DB í’ˆì§ˆì´ í™•ì‹¤íˆ ë‹¤ë¦…ë‹ˆë‹¤. ê³„ì•½ê¹Œì§€ ì´ì–´ì§€ëŠ” ê³ ê°ì´ ë§ì•„ìš”',
      },
      {
        industry: 'ì§ì—…êµìœ¡',
        period: '2ê°œì›”',
        stats: [
          { label: 'ê´‘ê³ ë¹„', value: 'â‚©200ë§Œ', change: 'ì›” ì˜ˆì‚°' },
          { label: 'DB ìˆ˜ì§‘', value: '100ê±´', change: 'ì›” í‰ê· ' },
          { label: 'ë“±ë¡ ì™„ë£Œ', value: '10ëª…', change: 'ì „í™˜ìœ¨ 10%' },
        ],
        quote: 'ìë™í™” ì‹œìŠ¤í…œìœ¼ë¡œ ë¬¸ì˜ ì‘ëŒ€ ì‹œê°„ì´ í™• ì¤„ì—ˆìŠµë‹ˆë‹¤',
      },
    ],
    ctaMessages: [
      'ë‹¤ìŒ ì„±ê³µ ì‚¬ë¡€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”',
      '30ë§Œì›ë¶€í„° ì‹œì‘í•´ì„œ ì´ëŸ° ì„±ê³¼ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”',
      'ì‹¤ì œ ê³ ê°ë“¤ì˜ ì„±ê³¼ì…ë‹ˆë‹¤',
    ],
  },
};

// í•´ì‹œíƒœê·¸ í’€
const HASHTAG_POOLS = {
  core: ['#í´ë¼ì• ë“œ', '#polarad', '#ì˜¨ë¼ì¸ë§ˆì¼€íŒ…', '#ì˜ì—…ìë™í™”', '#DBìˆ˜ì§‘'],
  service: ['#ë©”íƒ€ê´‘ê³ ', '#í™ˆí˜ì´ì§€ì œì‘', '#ì¸ì‡„ë¬¼', '#ëª…í•¨ì œì‘', '#ë¸Œëœë”©', '#ë¦¬ë“œì œë„ˆë ˆì´ì…˜', '#ë§ˆì¼€íŒ…ëŒ€í–‰'],
  target: ['#B2Bë§ˆì¼€íŒ…', '#ìŠ¤íƒ€íŠ¸ì—…', '#ì†Œìƒê³µì¸', '#ì°½ì—…', '#ì˜ì—…ëŒ€í‘œ', '#ì„¸ì¼ì¦ˆ'],
  feature: ['#ìë™í™”', '#CRM', '#ê³ ê°ê´€ë¦¬', '#ë§ˆì¼€íŒ…ìë™í™”', '#ì—…ë¬´íš¨ìœ¨'],
};

interface GeneratedContent {
  templateType: TemplateType;
  templateData: TemplateData;
  caption: string;
  hashtags: string[];
}

/**
 * Geminië¡œ Instagram ì»¨í…ì¸  ìƒì„±
 */
export async function generateInstagramContent(): Promise<GeneratedContent> {
  // ëœë¤ í…œí”Œë¦¿ íƒ€ì… ì„ íƒ
  const templateType = TEMPLATE_TYPES[Math.floor(Math.random() * TEMPLATE_TYPES.length)];

  // Geminië¡œ ì»¨í…ì¸  ìƒì„±
  const templateData = await generateContentWithGemini(templateType);

  // ìº¡ì…˜ ìƒì„±
  const caption = await generateCaptionWithGemini(templateType, templateData);

  // í•´ì‹œíƒœê·¸ ì„ íƒ
  const hashtags = selectHashtags(templateType);

  return {
    templateType,
    templateData,
    caption,
    hashtags,
  };
}

/**
 * Geminië¡œ í…œí”Œë¦¿ ë°ì´í„° ìƒì„±
 */
async function generateContentWithGemini(templateType: TemplateType): Promise<TemplateData> {
  if (!GEMINI_API_KEY) {
    console.log('âš ï¸ GEMINI_API_KEY ë¯¸ì„¤ì • - ê¸°ë³¸ ì»¨í…ì¸  ì‚¬ìš©');
    return getDefaultContent(templateType);
  }

  const topic = CONTENT_TOPICS[templateType];
  const prompt = buildPromptForTemplate(templateType, topic);

  try {
    const res = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${GEMINI_API_KEY}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.8,
            maxOutputTokens: 1000,
          },
        }),
      }
    );

    const result = await res.json();
    const responseText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

    if (responseText) {
      return parseGeminiResponse(templateType, responseText);
    }
  } catch (error) {
    console.error('Gemini ì»¨í…ì¸  ìƒì„± ì‹¤íŒ¨:', error);
  }

  return getDefaultContent(templateType);
}

/**
 * í…œí”Œë¦¿ íƒ€ì…ë³„ í”„ë¡¬í”„íŠ¸ ìƒì„±
 */
function buildPromptForTemplate(templateType: TemplateType, topic: any): string {
  const baseContext = `ë‹¹ì‹ ì€ PolarAD(í´ë¼ì• ë“œ) ë§ˆì¼€íŒ… íšŒì‚¬ì˜ Instagram ì»¨í…ì¸  ì‘ì„±ìì…ë‹ˆë‹¤.
PolarADëŠ” B2B ì˜ì—… ëŒ€í‘œë‹˜ë“¤ì„ ìœ„í•œ ìë™í™” ì ‘ìˆ˜ ì‹œìŠ¤í…œì„ ì œê³µí•˜ëŠ” íšŒì‚¬ì…ë‹ˆë‹¤.
ì£¼ìš” ì„œë¹„ìŠ¤: í™ˆí˜ì´ì§€ ì œì‘, Meta ê´‘ê³  ìš´ì˜, ì¸ì‡„ë¬¼ ì œì‘, ìë™í™” ì‹œìŠ¤í…œ

Instagram ì´ë¯¸ì§€ìš© í…ìŠ¤íŠ¸ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”. ì§§ê³  ì„íŒ©íŠ¸ ìˆê²Œ ì‘ì„±í•˜ì„¸ìš”.

âš ï¸ **[í•„ìˆ˜] ì¤„ë°”ê¿ˆ ê·œì¹™** - ë°˜ë“œì‹œ ì¤€ìˆ˜í•  ê²ƒ!
- í•œ ì¤„ì˜ ë§ˆì§€ë§‰ì— 1~2ê¸€ìë§Œ ë‚¨ëŠ” ì¤„ë°”ê¿ˆì€ ì ˆëŒ€ ê¸ˆì§€
- ì˜ˆì‹œ (ì˜ëª»ë¨): "B2B ì˜ì—…ìë™í™”, ì§€ê¸ˆ ì•ˆ í•˜\\në©´ ì†í•´" â†’ "ë©´ ì†í•´"ì²˜ëŸ¼ 1~2ê¸€ìë§Œ ë‚¨ìœ¼ë©´ ì•ˆ ë¨
- ì˜ˆì‹œ (ì˜¬ë°”ë¦„): "B2B ì˜ì—…ìë™í™”\\nì§€ê¸ˆ ì•ˆ í•˜ë©´ ì†í•´" â†’ ì˜ë¯¸ ë‹¨ìœ„ë¡œ ê¹”ë”í•˜ê²Œ ì¤„ë°”ê¿ˆ
- ì¤„ë°”ê¿ˆì€ ë°˜ë“œì‹œ ì˜ë¯¸ ë‹¨ìœ„(ë‹¨ì–´, êµ¬ì ˆ)ë¡œ ëŠì–´ì„œ ê° ì¤„ì´ ê· í˜• ìˆê²Œ êµ¬ì„±ë˜ì–´ì•¼ í•¨
- ê° ì¤„ì€ ìµœì†Œ 3ê¸€ì ì´ìƒì´ì–´ì•¼ í•¨`;

  switch (templateType) {
    case 'intro':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ë¸Œëœë“œ ì†Œê°œ
**ì°¸ê³  í…Œë§ˆ**: ${topic.themes.join(', ')}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "headline": "ë©”ì¸ í—¤ë“œë¼ì¸ (2ì¤„, ê° ì¤„ 10ì ì´ë‚´, \\nìœ¼ë¡œ êµ¬ë¶„)",
  "subHeadline": "ì„œë¸Œ í—¤ë“œë¼ì¸ (1-2ì¤„, ê° ì¤„ 15ì ì´ë‚´)",
  "items": [
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª… (4ì ì´ë‚´)"},
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª…"}
  ],
  "cta": "CTA ë²„íŠ¼ í…ìŠ¤íŠ¸ (6ì ì´ë‚´)"
}

ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'problem':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ë¬¸ì œ ì œê¸° (ì˜ì—… ëŒ€í‘œë‹˜ì˜ ê³ ë¯¼)
**ì°¸ê³  ê³ ë¯¼**: ${topic.painPoints.join(', ')}
**ì°¸ê³  ì§ˆë¬¸**: ${topic.questions.join(', ')}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "badge": "ë°°ì§€ í…ìŠ¤íŠ¸ (10ì ì´ë‚´)",
  "headline": "ë©”ì¸ ì§ˆë¬¸ (3-4ì¤„, ê° ì¤„ 8ì ì´ë‚´, \\nìœ¼ë¡œ êµ¬ë¶„, ê°•ì¡°í•  ë¶€ë¶„ì€ ê·¸ëŒ€ë¡œ)",
  "items": [
    {"text": "ë¬¸ì œ ì•ë¶€ë¶„", "highlight": "ê°•ì¡°í•  ë¶€ë¶„"},
    {"text": "", "highlight": "ê°•ì¡°í•  ë¶€ë¶„"},
    {"text": "ë¬¸ì œ ì•ë¶€ë¶„", "highlight": "ê°•ì¡°í•  ë¶€ë¶„"}
  ],
  "cta": "ì†”ë£¨ì…˜ ì œì•ˆ (12ì ì´ë‚´)",
  "subHeadline": "ì†”ë£¨ì…˜ ë¶€ì—° ì„¤ëª… (10ì ì´ë‚´)"
}

ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'solution':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ì†”ë£¨ì…˜ ì†Œê°œ (ì˜¬ì¸ì› íŒ¨í‚¤ì§€)
**ì°¸ê³  íŒ¨í‚¤ì§€**: ${JSON.stringify(topic.packages)}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "badge": "ë°°ì§€ í…ìŠ¤íŠ¸ (ì´ëª¨ì§€ í¬í•¨, 10ì ì´ë‚´)",
  "headline": "ë©”ì¸ í—¤ë“œë¼ì¸ (2ì¤„, gradient í´ë˜ìŠ¤ìš© ê°•ì¡° í…ìŠ¤íŠ¸ í¬í•¨)",
  "subHeadline": "ì„œë¸Œ í—¤ë“œë¼ì¸ (15ì ì´ë‚´)",
  "items": [
    {"icon": "ì´ëª¨ì§€", "text": "íŒ¨í‚¤ì§€ëª…", "highlight": "ì„¤ëª… (20ì ì´ë‚´)"},
    {"icon": "ì´ëª¨ì§€", "text": "íŒ¨í‚¤ì§€ëª…", "highlight": "ì„¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "íŒ¨í‚¤ì§€ëª…", "highlight": "ì„¤ëª…"}
  ],
  "cta": "í”„ë¡œëª¨ì…˜ ë¬¸êµ¬ (15ì ì´ë‚´, ì„ ì°©ìˆœ ë“±)"
}

ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'feature':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ê¸°ëŠ¥ ì†Œê°œ
**ì°¸ê³  ê¸°ëŠ¥**: ${JSON.stringify(topic.features)}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "headline": "ë©”ì¸ í—¤ë“œë¼ì¸ (2ì¤„, blue í´ë˜ìŠ¤ìš© ê°•ì¡° í…ìŠ¤íŠ¸ í¬í•¨, \\nìœ¼ë¡œ êµ¬ë¶„)",
  "subHeadline": "ì„¤ëª… (2ì¤„, ê° ì¤„ 15ì ì´ë‚´)",
  "items": [
    {"icon": "ì´ëª¨ì§€", "text": "ê¸°ëŠ¥ëª… (5ì ì´ë‚´)"},
    {"icon": "ì´ëª¨ì§€", "text": "ê¸°ëŠ¥ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ê¸°ëŠ¥ëª…"}
  ],
  "cta": "í•˜ë‹¨ ë©”ì‹œì§€ (20ì ì´ë‚´)"
}

ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'stats':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: í†µê³„/ë¦¬í¬íŠ¸ (Meta ê´‘ê³  ì„±ê³¼)
**ì°¸ê³  ì§€í‘œ**: ${JSON.stringify(topic.metrics)}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "badge": "ë°°ì§€ í…ìŠ¤íŠ¸ (ì´ëª¨ì§€ í¬í•¨)",
  "headline": "ë©”ì¸ í—¤ë“œë¼ì¸ (2ì¤„, blue í´ë˜ìŠ¤ìš© ê°•ì¡° í…ìŠ¤íŠ¸ í¬í•¨)",
  "subHeadline": "ì„œë¸Œ í—¤ë“œë¼ì¸",
  "stats": [
    {"label": "ì§€í‘œëª…", "value": "ê°’ (â‚©, ê±´, % ë“± í¬í•¨)", "change": "ë³€í™”ìœ¨ (â–²/â–¼ í¬í•¨)"},
    {"label": "ì§€í‘œëª…", "value": "ê°’", "change": "ë³€í™”ìœ¨"},
    {"label": "ì§€í‘œëª…", "value": "ê°’", "change": "ë³€í™”ìœ¨"}
  ]
}

ì‹¤ì œì²˜ëŸ¼ ë³´ì´ëŠ” ìˆ«ìë¥¼ ëœë¤í•˜ê²Œ ìƒì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'promo':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: í”„ë¡œëª¨ì…˜
**ì°¸ê³  ì˜¤í¼**: ${topic.offers.join(', ')}
**ì°¸ê³  í˜œíƒ**: ${topic.benefits.join(', ')}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "badge": "ë°°ì§€ í…ìŠ¤íŠ¸ (ì´ëª¨ì§€ í¬í•¨)",
  "headline": "ë©”ì¸ í—¤ë“œë¼ì¸ (2ì¤„, gold í´ë˜ìŠ¤ìš© ê°•ì¡° í…ìŠ¤íŠ¸ í¬í•¨, ì„ ì°©ìˆœ NíŒ€ ë“±)",
  "subHeadline": "ì„œë¸Œ í—¤ë“œë¼ì¸ (í˜œíƒ ìš”ì•½)",
  "cta": "í•µì‹¬ í˜œíƒ (10ì ì´ë‚´)"
}

ê¸´ë°•ê°ì„ ì£¼ëŠ” í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'service':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ì„œë¹„ìŠ¤ ìƒì„¸ ì†Œê°œ
**ì°¸ê³  ì„œë¹„ìŠ¤**: ${JSON.stringify(topic.services[Math.floor(Math.random() * topic.services.length)])}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "badge": "ë°°ì§€ í…ìŠ¤íŠ¸ (ì´ëª¨ì§€ í¬í•¨, ì„œë¹„ìŠ¤ëª…)",
  "headline": "ë©”ì¸ í—¤ë“œë¼ì¸ (2ì¤„, blue í´ë˜ìŠ¤ìš© ê°•ì¡° í…ìŠ¤íŠ¸ í¬í•¨)",
  "subHeadline": "í•µì‹¬ ê°€ì¹˜ ì„¤ëª… (2ì¤„)",
  "items": [
    {"icon": "ì´ëª¨ì§€", "text": "ê¸°ëŠ¥ëª…", "highlight": "ì„¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ê¸°ëŠ¥ëª…", "highlight": "ì„¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ê¸°ëŠ¥ëª…", "highlight": "ì„¤ëª…"}
  ],
  "cta": "CTA í…ìŠ¤íŠ¸"
}

ê¸°ì¡´ê³¼ ë‹¤ë¥¸ ìƒˆë¡œìš´ í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'case':
      const randomCase = topic.cases[Math.floor(Math.random() * topic.cases.length)];
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ì‹¤ì œ ì‚¬ë¡€/ì„±ê³¼
**ì°¸ê³  ì‚¬ë¡€**: ${JSON.stringify(randomCase)}
**CTA ë©”ì‹œì§€**: ${topic.ctaMessages.join(', ')}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "badge": "ë°°ì§€ í…ìŠ¤íŠ¸ (ì´ëª¨ì§€ í¬í•¨, ì˜ˆ: ğŸ“ˆ ì‹¤ì œ ì‚¬ë¡€)",
  "headline": "ê³ ê°/ì—…ì¢…ëª… (ì˜ˆ: ê²½ì˜ì»¨ì„¤íŒ… Aì‚¬)",
  "subHeadline": "ê³ ê° ì„¤ëª… (ì˜ˆ: ì˜ì—… ëŒ€í‘œë‹˜)",
  "stats": [
    {"label": "ì§€í‘œëª…", "value": "ê°’", "change": "ë¶€ê°€ ì„¤ëª…"},
    {"label": "ì§€í‘œëª…", "value": "ê°’", "change": "ë¶€ê°€ ì„¤ëª…"},
    {"label": "ì§€í‘œëª…", "value": "ê°’", "change": "ë¶€ê°€ ì„¤ëª…"}
  ],
  "cta": "ê³ ê° ì¶”ì²œì‚¬ (30ì ì´ë‚´)"
}

ì‹¤ì œ ì„±ê³¼ì²˜ëŸ¼ ë³´ì´ëŠ” ìˆ«ìë¥¼ ì‚¬ìš©í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    case 'cta':
      return `${baseContext}

**í…œí”Œë¦¿ íƒ€ì…**: ë§ˆë¬´ë¦¬ CTA
**ì°¸ê³  ë©”ì‹œì§€**: ${topic.messages.join(', ')}

ë‹¤ìŒ JSON í˜•ì‹ìœ¼ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
{
  "headline": "í•µì‹¬ ë©”ì‹œì§€ (1ì¤„, 10ì ì´ë‚´)",
  "subHeadline": "ë¶€ì—° ë©”ì‹œì§€ (15ì ì´ë‚´)",
  "items": [
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª…"},
    {"icon": "ì´ëª¨ì§€", "text": "ì„œë¹„ìŠ¤ëª…"}
  ],
  "cta": "CTA ë²„íŠ¼ í…ìŠ¤íŠ¸ (6ì ì´ë‚´)"
}

ê°ì„±ì ì´ê³  ì„¤ë“ë ¥ ìˆëŠ” í‘œí˜„ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”. JSONë§Œ ì¶œë ¥í•˜ì„¸ìš”.`;

    default:
      return `${baseContext}\n\nê¸°ë³¸ ë¸Œëœë“œ ì†Œê°œ ì»¨í…ì¸ ë¥¼ JSONìœ¼ë¡œ ìƒì„±í•˜ì„¸ìš”.`;
  }
}

/**
 * Gemini ì‘ë‹µ íŒŒì‹±
 */
function parseGeminiResponse(templateType: TemplateType, responseText: string): TemplateData {
  try {
    // JSON ì¶”ì¶œ (ì½”ë“œ ë¸”ë¡ ì œê±°)
    let jsonStr = responseText;
    if (jsonStr.includes('```')) {
      jsonStr = jsonStr.replace(/```json\n?/g, '').replace(/```\n?/g, '');
    }

    const parsed = JSON.parse(jsonStr.trim());
    return parsed as TemplateData;
  } catch (error) {
    console.error('Gemini ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', error);
    return getDefaultContent(templateType);
  }
}

/**
 * ê¸°ë³¸ ì»¨í…ì¸  (Gemini ì‹¤íŒ¨ ì‹œ)
 */
function getDefaultContent(templateType: TemplateType): TemplateData {
  const defaults: Record<TemplateType, TemplateData> = {
    intro: {
      headline: 'ì²´ê³„ì ì¸\nìë™í™” ì ‘ìˆ˜ ì‹œìŠ¤í…œ',
      subHeadline: 'ì•ˆì •ì ì¸ ë§¤ì¶œì°½ì¶œì„ ìœ„í•œ\nì˜¨ë¼ì¸ ì˜ì—… ì†”ë£¨ì…˜',
      items: [
        { icon: 'ğŸ–¥ï¸', text: 'í™ˆí˜ì´ì§€' },
        { icon: 'ğŸ“±', text: 'Meta ê´‘ê³ ' },
        { icon: 'ğŸ¤–', text: 'ë§ˆì¼€íŒ… ìë™í™”' },
      ],
      cta: 'ë¬´ë£Œ ìƒë‹´ ì‹ ì²­',
    },
    problem: {
      badge: 'ì˜ì—… ëŒ€í‘œë‹˜ê»˜ ë“œë¦¬ëŠ” ì§ˆë¬¸',
      headline: 'ì•„ì§ë„\në‚¨ë“¤ì´ ë²„ë¦° DBì—\nì „í™”ë¥¼ ëŒë¦¬ê³ \nê³„ì‹­ë‹ˆê¹Œ?',
      items: [
        { text: 'ê³µìœ  DBë¡œ', highlight: 'ê²½ìŸë§Œ ì¹˜ì—´' },
        { text: '', highlight: 'ë¯¸íŒ… ì„±ì‚¬ìœ¨ 5% ë¯¸ë§Œ' },
        { text: 'ë§¤ì›”', highlight: 'ìˆ˜ë°±ë§Œ ì› DB ë¹„ìš©' },
      ],
      cta: 'ì²´ê³„ì ì¸ ìë™í™” ì ‘ìˆ˜ ì‹œìŠ¤í…œ',
      subHeadline: 'ì˜ì—…ì—ë§Œ ì§‘ì¤‘í•˜ì‹œë©´ ë©ë‹ˆë‹¤',
    },
    solution: {
      badge: 'âœ¨ 4í‹°ì–´ ì‹œìŠ¤í…œ',
      headline: 'í•„ìš”í•œ ë§Œí¼ë§Œ ì„ íƒí•˜ì„¸ìš”\n30ë§Œì›ë¶€í„° ì‹œì‘',
      subHeadline: 'ëœë”©í˜ì´ì§€ë¶€í„° í™ˆí˜ì´ì§€+ìë™í™”ê¹Œì§€',
      items: [
        { icon: 'ğŸ¯', text: 'Basic~Normal', highlight: 'ëœë”© 1P + Meta ì„¸íŒ… (30~60ë§Œì›)' },
        { icon: 'ğŸš€', text: 'Pro', highlight: 'í™ˆí˜ì´ì§€ 5P + Meta ì„¸íŒ… (110ë§Œì›)' },
        { icon: 'ğŸ‘‘', text: 'Premium', highlight: 'í™ˆí˜ì´ì§€ 10P + 6ê°œì›” ìë™í™” (220ë§Œì›)' },
      ],
      cta: '1/31ê¹Œì§€ Premium 165ë§Œì› + 1ë…„ ìë™í™” ë¬´ë£Œ!',
    },
    feature: {
      headline: 'ì²´ê³„ì ì¸\nìë™í™” ì ‘ìˆ˜ ì‹œìŠ¤í…œ',
      subHeadline: '24ì‹œê°„ ìë™ìœ¼ë¡œ ê³ ê° ë¬¸ì˜ë¥¼ ì ‘ìˆ˜í•˜ê³ \nì‹¤ì‹œê°„ ì•Œë¦¼ìœ¼ë¡œ ë¹ ë¥´ê²Œ ëŒ€ì‘í•˜ì„¸ìš”',
      items: [
        { icon: 'ğŸ””', text: 'ì‹¤ì‹œê°„ ì•Œë¦¼' },
        { icon: 'ğŸ“‚', text: 'ìë™ ë¶„ë¥˜' },
        { icon: 'ğŸ’¾', text: 'DB ê´€ë¦¬' },
      ],
      cta: 'ëŒ€í‘œë‹˜ì´ ì˜ì—…ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆë„ë¡',
    },
    stats: {
      badge: 'ğŸ“Š ìë™ ë¦¬í¬íŒ…',
      headline: 'Meta ê´‘ê³ \nìë™ë¦¬í¬íŠ¸ ì‹œìŠ¤í…œ',
      subHeadline: 'ê´‘ê³  ì„±ê³¼ë¥¼ í•œëˆˆì—, ìë™ìœ¼ë¡œ ë¦¬í¬íŒ…',
      stats: [
        { label: 'ì´ ì§€ì¶œ', value: 'â‚©2.8M', change: 'ì˜ˆì‚° ëŒ€ë¹„ 94%' },
        { label: 'DB ìˆ˜ì§‘', value: '127ê±´', change: 'â–² 23% vs ì§€ë‚œì£¼' },
        { label: 'DBë‹¹ ë‹¨ê°€', value: 'â‚©22K', change: 'â–¼ 12% ê°œì„ ' },
      ],
    },
    promo: {
      badge: 'ğŸ 1ì›” í”„ë¡œëª¨ì…˜',
      headline: 'Premium 165ë§Œì›\n+ 1ë…„ ìë™í™” ë¬´ë£Œ!',
      subHeadline: '1/31ê¹Œì§€ ì„ ì°©ìˆœ 10ê°œ ê¸°ì—…',
      cta: 'ì •ê°€ 220ë§Œì› â†’ 55ë§Œì› í• ì¸',
    },
    service: {
      badge: 'ğŸ–¥ï¸ í™ˆí˜ì´ì§€ ì œì‘',
      headline: 'ì „í™˜ìœ¨ ë†’ì€\ní™ˆí˜ì´ì§€ ì œì‘',
      subHeadline: 'ë‹¨ìˆœ í™ˆí˜ì´ì§€ê°€ ì•„ë‹™ë‹ˆë‹¤\nDBë¥¼ ì¶”ì¶œí•˜ëŠ” ì „í™˜ ê¸°ì§€ì…ë‹ˆë‹¤',
      items: [
        { icon: 'ğŸ“±', text: 'ë°˜ì‘í˜• ì›¹', highlight: 'PC, ëª¨ë°”ì¼ ëª¨ë‘ ìµœì í™”' },
        { icon: 'ğŸ”', text: 'SEO ìµœì í™”', highlight: 'ê²€ìƒ‰ì—”ì§„ ìƒìœ„ ë…¸ì¶œ' },
        { icon: 'ğŸ“‹', text: 'DB í¼ ì—°ë™', highlight: 'ê³ ê° ë¬¸ì˜ ìë™ ìˆ˜ì§‘' },
      ],
      cta: 'ë¬´ë£Œ ìƒë‹´ ë°›ì•„ë³´ì„¸ìš”',
    },
    case: {
      badge: 'ğŸ“ˆ ì‹¤ì œ ì‚¬ë¡€',
      headline: 'ê²½ì˜ì»¨ì„¤íŒ… Aì‚¬',
      subHeadline: 'ì˜ì—… ëŒ€í‘œë‹˜',
      stats: [
        { label: 'ê´‘ê³ ë¹„', value: 'â‚©320ë§Œ', change: 'ì›” ì˜ˆì‚°' },
        { label: 'DB ìˆ˜ì§‘', value: '150ê±´', change: 'ì›” í‰ê· ' },
        { label: 'ê³„ì•½ ì„±ì‚¬', value: '15ê±´', change: 'ì „í™˜ìœ¨ 10%' },
      ],
      cta: 'í´ë¼ì• ë“œ ë•ë¶„ì— ì˜ì—…ì—ë§Œ ì§‘ì¤‘í•  ìˆ˜ ìˆê²Œ ëìŠµë‹ˆë‹¤',
    },
    cta: {
      headline: 'ì˜ì—…ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”',
      subHeadline: 'ë‚˜ë¨¸ì§€ëŠ” ì €í¬ê°€ ë‹¤ í•´ë“œë¦½ë‹ˆë‹¤',
      items: [
        { icon: 'ğŸ–¥ï¸', text: 'í™ˆí˜ì´ì§€' },
        { icon: 'ğŸ“±', text: 'Meta ê´‘ê³ ' },
        { icon: 'ğŸ“Š', text: 'ìë™ ë¦¬í¬íŠ¸' },
        { icon: 'ğŸ””', text: 'ì‹¤ì‹œê°„ ì•Œë¦¼' },
      ],
      cta: 'ë¬´ë£Œ ìƒë‹´ ì‹ ì²­',
    },
  };

  return defaults[templateType];
}

/**
 * Geminië¡œ ìº¡ì…˜ ìƒì„± (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
 */
async function generateCaptionWithGemini(templateType: TemplateType, templateData: TemplateData): Promise<string> {
  if (!GEMINI_API_KEY) {
    console.warn('âš ï¸ GEMINI_API_KEY ë¯¸ì„¤ì • - ê¸°ë³¸ ìº¡ì…˜ ì‚¬ìš©');
    return getDefaultCaption(templateType, templateData);
  }

  // ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„
  for (let attempt = 1; attempt <= 3; attempt++) {
    try {
      const caption = await callGeminiForCaption(templateType, templateData);
      if (caption && caption.length >= 500) {
        console.log(`âœ… ìº¡ì…˜ ìƒì„± ì„±ê³µ (ì‹œë„ ${attempt}): ${caption.length}ì`);
        return caption;
      }
      console.warn(`âš ï¸ ìº¡ì…˜ ê¸¸ì´ ë¶€ì¡± (ì‹œë„ ${attempt}): ${caption?.length || 0}ì`);
    } catch (error) {
      console.error(`âŒ ìº¡ì…˜ ìƒì„± ì‹¤íŒ¨ (ì‹œë„ ${attempt}):`, error);
    }

    // ì¬ì‹œë„ ì „ ëŒ€ê¸°
    if (attempt < 3) {
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
  }

  console.warn('âš ï¸ ëª¨ë“  ìº¡ì…˜ ìƒì„± ì‹œë„ ì‹¤íŒ¨ - ê¸°ë³¸ ìº¡ì…˜ ì‚¬ìš©');
  return getDefaultCaption(templateType, templateData);
}

/**
 * Gemini API í˜¸ì¶œ (ìº¡ì…˜)
 */
async function callGeminiForCaption(templateType: TemplateType, templateData: TemplateData): Promise<string | null> {
  const prompt = `ë‹¹ì‹ ì€ PolarAD(í´ë¼ì• ë“œ) ë§ˆì¼€íŒ… íšŒì‚¬ì˜ Instagram ìº¡ì…˜ ì „ë¬¸ ì‘ì„±ìì…ë‹ˆë‹¤.
B2B ì˜ì—… ëŒ€í‘œë‹˜ë“¤ì„ ìœ„í•œ "ì˜¨ë¼ì¸ ì˜ì—… ì‹œìŠ¤í…œ"ì„ ì œê³µí•©ë‹ˆë‹¤.

**[í•µì‹¬ ì „ëµ] ì €ë¶€ë‹´ ì‹œì‘ â†’ ì„±ê³¼ í™•ì¸ â†’ ì—…ê·¸ë ˆì´ë“œ**

âš ï¸ ìº¡ì…˜ì— ë°˜ë“œì‹œ í¬í•¨í•  í•µì‹¬ ë©”ì‹œì§€:
   - "30ë§Œì›ë¶€í„° ë¶€ë‹´ ì—†ì´ ì‹œì‘"
   - "ë¨¼ì € Basicìœ¼ë¡œ íš¨ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”"
   - "ì„±ê³¼ë¥¼ ë³´ê³  ì—…ê·¸ë ˆì´ë“œí•˜ì…”ë„ ë©ë‹ˆë‹¤"
   - ë¹„ìš© ë¶€ë‹´ì„ ë‚®ì¶° ì ‘ìˆ˜ìœ¨/ê³„ì•½ë¥  í–¥ìƒ ìœ ë„

**[ì¤‘ìš”] í´ë¼ì• ë“œ 4í‹°ì–´ ì‹œìŠ¤í…œ - í•„ìš”í•œ ë§Œí¼ë§Œ ì„ íƒ**:

ğŸ“Œ í‹°ì–´ë³„ êµ¬ì„± (VAT í¬í•¨):
   - Basic 30ë§Œì›: ëœë”©í˜ì´ì§€ 1P (ë¶€ë‹´ ì—†ì´ ì‹œì‘!)
   - Normal 60ë§Œì›: ëœë”© 1P + Meta ê´‘ê³  ì„¸íŒ… + ë„ë©”ì¸ 1ë…„
   - Pro 110ë§Œì›: í™ˆí˜ì´ì§€ 5P + Meta ê´‘ê³  ì„¸íŒ… + ë„ë©”ì¸ 1ë…„
   - Premium 165ë§Œì›: í™ˆí˜ì´ì§€ 10P + 1ë…„ ìë™í™” (í”„ë¡œëª¨ì…˜!)

ğŸ“Œ í™ˆí˜ì´ì§€
   - PC, íƒœë¸”ë¦¿, ëª¨ë°”ì¼ ë°˜ì‘í˜• ì›¹
   - SEO ìµœì í™”ë¡œ ê²€ìƒ‰ ìƒìœ„ ë…¸ì¶œ
   - DB ìˆ˜ì§‘ í¼ ì—°ë™ (ê³ ê° ë¬¸ì˜ ìë™ ìˆ˜ì§‘)

ğŸ“Œ Meta ê´‘ê³ 
   - Facebook/Instagram ê´‘ê³  ì„¸íŒ…
   - íƒ€ê²Ÿ ì˜¤ë””ì–¸ìŠ¤ ìµœì í™”
   - ì‹¤ì‹œê°„ ì„±ê³¼ ì¶”ì 

ğŸ“Œ ë§ˆì¼€íŒ… ìë™í™” (Premium í¬í•¨)
   - í…”ë ˆê·¸ë¨ ì‹¤ì‹œê°„ DB ì•Œë¦¼
   - SMS ìë™ ë°œì†¡
   - ê´‘ê³  ì„±ê³¼ ìë™ ë¦¬í¬íŠ¸

â†’ ëŒ€í‘œë‹˜ì€ ê³ ê° ë¯¸íŒ…ê³¼ ê³„ì•½ ì„±ì‚¬ì—ë§Œ ì§‘ì¤‘í•˜ì‹œë©´ ë©ë‹ˆë‹¤.

ğŸ **[1ì›” í”„ë¡œëª¨ì…˜] 2026ë…„ 1ì›” 31ì¼ê¹Œì§€, ì„ ì°©ìˆœ 10ê°œ ê¸°ì—…**

   ğŸ¯ Premium 165ë§Œì› (ì •ê°€ 220ë§Œì› â†’ 55ë§Œì› í• ì¸)
   ğŸ¯ 1ë…„ ìë™í™” ë¬´ë£Œ ì œê³µ (6ê°œì›” â†’ 1ë…„ìœ¼ë¡œ ì—…ê·¸ë ˆì´ë“œ)
   â†’ ìº¡ì…˜ì— "165ë§Œì›" í”„ë¡œëª¨ì…˜ê³¼ "1ë…„ ìë™í™” ë¬´ë£Œ" ê°•ì¡°í•  ê²ƒ!

**ì»¨í…ì¸  ì •ë³´**:
- íƒ€ì…: ${templateType}
- í—¤ë“œë¼ì¸: ${templateData.headline}
- ì„œë¸Œí—¤ë“œë¼ì¸: ${templateData.subHeadline || ''}
- ì•„ì´í…œ: ${JSON.stringify(templateData.items || [])}

**ìº¡ì…˜ ì‘ì„± ê°€ì´ë“œë¼ì¸**:

âš ï¸ **[í•„ìˆ˜] ìµœì†Œ 1000ì ì´ìƒ ì‘ì„±í•  ê²ƒ!** (í•´ì‹œíƒœê·¸ ì œì™¸)
â†’ ì§§ì€ ìº¡ì…˜ì€ ì¸ìŠ¤íƒ€ê·¸ë¨ ì•Œê³ ë¦¬ì¦˜ì— ë¶ˆë¦¬í•©ë‹ˆë‹¤.
â†’ ë°˜ë“œì‹œ ì•„ë˜ êµ¬ì¡°ë¥¼ ëª¨ë‘ í¬í•¨í•´ì„œ ì¶©ë¶„í•œ ë¶„ëŸ‰ìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”.

1. **ì´ ê¸¸ì´**: 1000~1500ì (í•´ì‹œíƒœê·¸ ì œì™¸) - ë°˜ë“œì‹œ ì§€í‚¬ ê²ƒ!

2. **ì¸ìŠ¤íƒ€ê·¸ë¨ ê°€ë¡œí­ ìµœì í™”**:
   - í•œ ì¤„ë‹¹ 25~30ì ì´ë‚´ë¡œ ì‘ì„±
   - ë„ˆë¬´ ê¸´ ë¬¸ì¥ì€ ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ
   - ë¹ˆ ì¤„ë¡œ ë¬¸ë‹¨ êµ¬ë¶„í•˜ì—¬ ê°€ë…ì„± í™•ë³´

3. **êµ¬ì¡° (í•„ìˆ˜)**:

[ë„ì…ë¶€ - 3~4ì¤„]
- í•µì‹¬ ì§ˆë¬¸ì´ë‚˜ ê³µê° í¬ì¸íŠ¸ë¡œ ì‹œì‘
- ì´ëª¨ì§€ 1~2ê°œ í™œìš©
- ë…ìì˜ ê´€ì‹¬ì„ ë„ëŠ” í›„í‚¹

[ë³¸ë¬¸ - 15~20ì¤„] â† ì¶©ë¶„íˆ ê¸¸ê²Œ!
- ë¬¸ì œ ìƒí™©ì„ êµ¬ì²´ì ìœ¼ë¡œ ì„¤ëª… (3~4ì¤„)
- ì™œ ì´ê²ƒì´ ì¤‘ìš”í•œì§€ ìƒì„¸íˆ (3~4ì¤„)
- í´ë¼ì• ë“œì˜ ì†”ë£¨ì…˜ì´ ì–´ë–»ê²Œ ë„ì›€ì´ ë˜ëŠ”ì§€ (4~5ì¤„)
- êµ¬ì²´ì ì¸ ì˜ˆì‹œ, ìˆ˜ì¹˜, ê³ ê° ì‚¬ë¡€ ì–¸ê¸‰ (3~4ì¤„)
- ê° ë¬¸ë‹¨ì€ 3~4ì¤„ í›„ ë¹ˆ ì¤„ë¡œ êµ¬ë¶„

[ì²´í¬ë¦¬ìŠ¤íŠ¸ ì„¹ì…˜ - 4í‹°ì–´ ì‹œìŠ¤í…œ ê°•ì¡°]
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
âœ… 30ë§Œì›ë¶€í„° ë¶€ë‹´ ì—†ì´ ì‹œì‘ ê°€ëŠ¥
âœ… PC/ëª¨ë°”ì¼ ë°˜ì‘í˜• ì›¹ì‚¬ì´íŠ¸
âœ… Meta ê´‘ê³  íƒ€ê²ŸíŒ… ì„¤ì •
âœ… í…”ë ˆê·¸ë¨/SMS ì‹¤ì‹œê°„ ì•Œë¦¼ (Premium)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
â†’ "ë¨¼ì € Basicìœ¼ë¡œ ì‹œì‘í•´ë³´ì„¸ìš”" ë©”ì‹œì§€ í•„ìˆ˜!

[ë§ˆë¬´ë¦¬ - 4~5ì¤„]
- í”„ë¡œëª¨ì…˜ í˜œíƒ ë‹¤ì‹œ í•œë²ˆ ê°•ì¡°
- ê¸´ë°•ê° ìˆëŠ” í–‰ë™ ìœ ë„ ë©”ì‹œì§€
- "ğŸ’¬ ë¬´ë£Œ ìƒë‹´ â†’ í”„ë¡œí•„ ë§í¬"ë¡œ ë§ˆë¬´ë¦¬
- ê°„ë‹¨í•œ ë§ˆë¬´ë¦¬ ì¸ì‚¬ ì¶”ê°€

4. **í†¤ì•¤ë§¤ë„ˆ**:
- ì „ë¬¸ì ì´ë©´ì„œ ì¹œê·¼í•˜ê²Œ
- B2B ì˜ì—… ëŒ€í‘œë‹˜ ëŒ€ìƒ
- "~í•˜ì„¸ìš”", "~ì…ë‹ˆë‹¤" ì¡´ëŒ“ë§
- ê³¼ì¥ ì—†ì´ ì‹ ë¢°ê° ìˆê²Œ

5. **ê¸ˆì§€ì‚¬í•­**:
- í•´ì‹œíƒœê·¸ í¬í•¨ ê¸ˆì§€ (ë³„ë„ ì¶”ê°€ë¨)
- ì´ëª¨ì§€ ê³¼ë‹¤ ì‚¬ìš© ê¸ˆì§€ (ì „ì²´ 5~7ê°œ ì´ë‚´)
- í•œ ì¤„ì— 35ì ì´ìƒ ê¸ˆì§€

âš ï¸ ë°˜ë“œì‹œ 1000ì ì´ìƒìœ¼ë¡œ ì‘ì„±í•˜ì„¸ìš”! ì§§ìœ¼ë©´ ë‹¤ì‹œ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤.
ìº¡ì…˜ë§Œ ì¶œë ¥í•˜ì„¸ìš”. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ ìº¡ì…˜ í…ìŠ¤íŠ¸ë§Œ ì‘ì„±í•˜ì„¸ìš”.`;

  const res = await fetch(
    `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${GEMINI_API_KEY}`,
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{ parts: [{ text: prompt }] }],
        generationConfig: { temperature: 0.75, maxOutputTokens: 4000 },
      }),
    }
  );

  if (!res.ok) {
    throw new Error(`Gemini API error: ${res.status}`);
  }

  const result = await res.json();
  const caption = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim();

  return caption || null;
}

/**
 * ê¸°ë³¸ ìº¡ì…˜ ìƒì„± (Gemini ì‹¤íŒ¨ ì‹œ ì‚¬ìš©)
 */
function getDefaultCaption(templateType: TemplateType, data: TemplateData): string {
  const headline = data.headline?.replace(/\n/g, ' ') || 'ì²´ê³„ì ì¸ ìë™í™” ì ‘ìˆ˜ ì‹œìŠ¤í…œ';

  return `${headline} ğŸ“Š

ì•„ì§ë„ ë‚¨ë“¤ì´ ë²„ë¦° DBì—
ì „í™”ë¥¼ ëŒë¦¬ê³  ê³„ì‹­ë‹ˆê¹Œ?

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ê³µìœ  DBë¡œ ê²½ìŸë§Œ ì¹˜ì—´í•˜ê³ ,
ë¯¸íŒ… ì„±ì‚¬ìœ¨ì€ 5%ë„ ì•ˆ ë˜ê³ ,
ë§¤ì›” ìˆ˜ë°±ë§Œ ì› DB ë¹„ìš©ë§Œ ë‚˜ê°€ê³ ...

ì˜ì—… ëŒ€í‘œë‹˜ë“¤ì˜ ê³ ë¯¼,
í´ë¼ì• ë“œê°€ í•´ê²°í•´ë“œë¦½ë‹ˆë‹¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âœ… í´ë¼ì• ë“œ 4í‹°ì–´ ì‹œìŠ¤í…œ

ğŸ“Œ Basic 30ë§Œì› - ëœë”©í˜ì´ì§€ 1P
ğŸ“Œ Normal 60ë§Œì› - +Meta ì„¸íŒ…+ë„ë©”ì¸
ğŸ“Œ Pro 110ë§Œì› - í™ˆí˜ì´ì§€ 5P
ğŸ“Œ Premium 220ë§Œì› - í™ˆí˜ì´ì§€ 10P+ìë™í™”

ğŸ’¡ 30ë§Œì›ë¶€í„° ë¶€ë‹´ ì—†ì´ ì‹œì‘!
ë¨¼ì € Basicìœ¼ë¡œ íš¨ê³¼ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.
ì„±ê³¼ë¥¼ ë³´ê³  ì—…ê·¸ë ˆì´ë“œí•˜ì…”ë„ ë©ë‹ˆë‹¤.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ 1ì›” í”„ë¡œëª¨ì…˜ (~1/31)
   ì„ ì°©ìˆœ 10ê°œ ê¸°ì—… í•œì •!

   Premium 165ë§Œì›
   + 1ë…„ ìë™í™” ë¬´ë£Œ

   (ì •ê°€ 220ë§Œì› â†’ 55ë§Œì› í• ì¸)

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ëŒ€í‘œë‹˜ì€ ê³ ê° ë¯¸íŒ…ê³¼
ê³„ì•½ ì„±ì‚¬ì—ë§Œ ì§‘ì¤‘í•˜ì„¸ìš”.

ë‚˜ë¨¸ì§€ëŠ” ì €í¬ê°€ ë‹¤ í•´ë“œë¦½ë‹ˆë‹¤.

ğŸ’¬ ë¬´ë£Œ ìƒë‹´ ì‹ ì²­
   â†’ í”„ë¡œí•„ ë§í¬ í´ë¦­`;
}

/**
 * í•´ì‹œíƒœê·¸ ì„ íƒ
 */
function selectHashtags(templateType: TemplateType): string[] {
  const selected: string[] = [];

  // ì½”ì–´ í•´ì‹œíƒœê·¸ (2-3ê°œ)
  const coreCount = 2 + Math.floor(Math.random() * 2);
  const shuffledCore = [...HASHTAG_POOLS.core].sort(() => Math.random() - 0.5);
  selected.push(...shuffledCore.slice(0, coreCount));

  // ì„œë¹„ìŠ¤ í•´ì‹œíƒœê·¸ (2-3ê°œ)
  const serviceCount = 2 + Math.floor(Math.random() * 2);
  const shuffledService = [...HASHTAG_POOLS.service].sort(() => Math.random() - 0.5);
  selected.push(...shuffledService.slice(0, serviceCount));

  // íƒ€ê²Ÿ í•´ì‹œíƒœê·¸ (1-2ê°œ)
  const targetCount = 1 + Math.floor(Math.random() * 2);
  const shuffledTarget = [...HASHTAG_POOLS.target].sort(() => Math.random() - 0.5);
  selected.push(...shuffledTarget.slice(0, targetCount));

  // ê¸°ëŠ¥ í•´ì‹œíƒœê·¸ (1-2ê°œ)
  const featureCount = 1 + Math.floor(Math.random() * 2);
  const shuffledFeature = [...HASHTAG_POOLS.feature].sort(() => Math.random() - 0.5);
  selected.push(...shuffledFeature.slice(0, featureCount));

  return selected;
}
